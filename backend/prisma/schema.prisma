// This is your Prisma schema file
// Learn more: https://pris.ly/d/prisma-schema

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

// User Model - Base authentication
model User {
  id            String   @id @default(uuid())
  email         String   @unique
  passwordHash  String?  // Optional for Firebase users
  firebaseUid   String?  @unique // For Firebase Auth integration
  role          Role     @default(PATIENT)
  emailVerified Boolean  @default(false)
  accountStatus AccountStatus @default(PENDING_VERIFICATION)
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  lastLogin     DateTime?

  // Relations
  patient       Patient?
  doctor        Doctor?
  staff         Staff?
  sessions      Session[]
  
  @@index([email])
  @@index([firebaseUid])
  @@map("users")
}

// Session Model - For JWT refresh tokens
model Session {
  id           String   @id @default(uuid())
  userId       String
  refreshToken String   @unique
  expiresAt    DateTime
  createdAt    DateTime @default(now())
  
  user User @relation(fields: [userId], references: [id], onDelete: Cascade)
  
  @@index([userId])
  @@index([refreshToken])
  @@map("sessions")
}

// Patient Profile
model Patient {
  id              String   @id @default(uuid())
  userId          String   @unique
  fullName        String
  dateOfBirth     DateTime?
  gender          Gender?
  phoneNumber     String?
  address         String?
  bloodGroup      String?
  emergencyContact String?
  
  user            User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  appointments    Appointment[]
  healthRecords   HealthRecord[]
  prescriptions   Prescription[]
  
  @@map("patients")
}

// Doctor Profile with Verification
model Doctor {
  id                String   @id @default(uuid())
  userId            String   @unique
  fullName          String
  specialization    String
  licenseNumber     String?  @unique
  medicalCouncil    String?
  qualification     String?
  experience        Int?     // years
  phoneNumber       String?
  
  // Verification fields
  verificationStatus VerificationStatus @default(PENDING)
  verificationDocument String? // URL to uploaded license
  verifiedAt        DateTime?
  verifiedBy        String?  // Admin user ID who verified
  
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  appointments      Appointment[]
  prescriptions     Prescription[]
  
  @@index([licenseNumber])
  @@map("doctors")
}

// Staff Profile with Organization Verification
model Staff {
  id                String   @id @default(uuid())
  userId            String   @unique
  fullName          String
  organizationId    String?
  employeeId        String?
  department        String?
  position          String?
  phoneNumber       String?
  
  // Verification fields
  verificationStatus VerificationStatus @default(PENDING)
  verificationDocument String? // URL to uploaded ID
  verifiedAt        DateTime?
  verifiedBy        String?
  
  user              User     @relation(fields: [userId], references: [id], onDelete: Cascade)
  organization      Organization? @relation(fields: [organizationId], references: [id])
  
  @@map("staff")
}

// Organization Model (Hospitals, Clinics)
model Organization {
  id            String   @id @default(uuid())
  name          String
  type          String   // Hospital, Clinic, Lab
  address       String?
  phoneNumber   String?
  emailDomain   String   @unique // e.g., "cityhospital.com"
  isVerified    Boolean  @default(false)
  createdAt     DateTime @default(now())
  
  staff         Staff[]
  
  @@map("organizations")
}

// Appointment Model
model Appointment {
  id            String   @id @default(uuid())
  patientId     String
  doctorId      String
  scheduledAt   DateTime
  duration      Int      @default(30) // minutes
  status        AppointmentStatus @default(SCHEDULED)
  reason        String?
  notes         String?
  createdAt     DateTime @default(now())
  updatedAt     DateTime @updatedAt
  
  patient       Patient  @relation(fields: [patientId], references: [id])
  doctor        Doctor   @relation(fields: [doctorId], references: [id])
  
  @@index([patientId])
  @@index([doctorId])
  @@index([scheduledAt])
  @@map("appointments")
}

// Health Record Model
model HealthRecord {
  id            String   @id @default(uuid())
  patientId     String
  recordType    RecordType
  title         String
  description   String?
  fileUrl       String?
  fileSize      Int?
  mimeType      String?
  uploadedAt    DateTime @default(now())
  recordDate    DateTime @default(now())
  
  patient       Patient  @relation(fields: [patientId], references: [id])
  
  @@index([patientId])
  @@index([recordType])
  @@map("health_records")
}

// Prescription Model
model Prescription {
  id            String   @id @default(uuid())
  patientId     String
  doctorId      String
  diagnosis     String?
  medications   Json     // Array of {name, dosage, frequency, duration}
  instructions  String?
  issuedAt      DateTime @default(now())
  validUntil    DateTime?
  
  patient       Patient  @relation(fields: [patientId], references: [id])
  doctor        Doctor   @relation(fields: [doctorId], references: [id])
  
  @@index([patientId])
  @@index([doctorId])
  @@map("prescriptions")
}

// Enums
enum Role {
  PATIENT
  DOCTOR
  STAFF
  ADMIN
}

enum AccountStatus {
  PENDING_VERIFICATION
  ACTIVE
  SUSPENDED
  DELETED
}

enum VerificationStatus {
  PENDING
  APPROVED
  REJECTED
}

enum Gender {
  MALE
  FEMALE
  OTHER
}

enum AppointmentStatus {
  SCHEDULED
  CONFIRMED
  IN_PROGRESS
  COMPLETED
  CANCELLED
  NO_SHOW
}

enum RecordType {
  LAB_REPORT
  PRESCRIPTION
  IMAGING
  VACCINATION
  MEDICAL_HISTORY
  OTHER
}
